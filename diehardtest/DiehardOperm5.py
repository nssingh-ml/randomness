import numpy as np
from scipy.stats import chi2

class DiehardOPERM5:
    @staticmethod
    def run_test(data, samples=1000000, overlap=True):
        """
        Runs the Diehard OPERM5 test on the provided data.

        :param data: Input data as binary string, bytes, or list of integers.
        :param samples: Number of 5-permutation samples to use (default: 1,000,000).
        :param overlap: Whether to use overlapping samples (default: True).
        :return: Tuple (p_value, result), where p_value is the calculated p-value, and result is "Random" or "Non-Random".
        """
        try:
            # Convert input to numerical format if necessary
            data  = list(map(int, data))
            numerical_data = DiehardOPERM5._prepare_data(data)

            # Ensure enough data for the required samples
            if len(numerical_data) < 5:
                raise ValueError("Insufficient data length. At least 5 integers are required.")

            # Count occurrences of each permutation
            counts = np.zeros(120, dtype=float)
            if overlap:
                for i in range(samples):
                    indices = numerical_data[i % len(numerical_data): i % len(numerical_data) + 5]
                    # print(indices)
                    if(len(indices)==5):
                        perm_index = DiehardOPERM5._perm_index(indices)
                        counts[perm_index] += 1
            else:
                for i in range(0, samples * 5, 5):
                    if i + 5 <= len(numerical_data):
                        indices = numerical_data[i:i + 5]
                        perm_index = DiehardOPERM5._perm_index(indices)
                        counts[perm_index] += 1

            # Expected counts for uniform distribution
            expected = np.full(120, samples / 120)

            # Calculate chi-square statistic
            chi_square = np.sum(((counts - expected) ** 2) / expected)

            # Degrees of freedom for overlapping vs non-overlapping
            ndof = 96 if overlap else 119

            # Calculate p-value
            p_value = chi2.sf(chi_square, ndof)

            # Determine result based on p-value
            result = "Random" if p_value > 0.01 else "Non-Random"
            return p_value, result
        except Exception as e:
            raise ValueError(f"Error in OPERM5 Test: {e}")

    @staticmethod
    def _perm_index(v):
        """
        Computes the permutation index of a vector of 5 integers.

        :param v: List of 5 integers.
        :return: Permutation index (0 to 119).
        """
        w = list(v)
        p_index = 0
        for i in range(4, 0, -1):
            max_idx = max(range(i + 1), key=w.__getitem__)
            p_index = (i + 1) * p_index + max_idx
            w[i], w[max_idx] = w[max_idx], w[i]
        return p_index

    @staticmethod
    def _prepare_data(data):
        """
        Converts input data into a list of integers.

        :param data: Input data as binary string, bytes, or list.
        :return: List of integers.
        """
        if isinstance(data, str):
            return [ord(char) for char in data]
        elif isinstance(data, (bytes, bytearray)):
            return list(data)
        elif isinstance(data, list):
            return data
        else:
            raise ValueError("Unsupported data type. Provide binary string, bytes, or list of integers.")

# Example usage
if __name__ == "__main__":
    # Generate random test data
    rng = np.random.default_rng()
    test_data = rng.integers(0, 256, size=1000005, dtype=int).tolist()
    # rng = np.random.default_rng()
    # binary_data = rng.integers(0, 256, size=10000, dtype=int).tolist()
    # test_data = "1101010010001100001001010001111101000110110100010101110010010000000011001100011011001111010111110110001010111111001000010011001100010001100101110110111111011011100010101011111100101010011000001000011011101001001100100111100001100001001101010011010000010001010000000001000111000101011101001101011110111010100011100110100101100101101101111001111000110011110011011011011000000011101110000001010111110011110010000000001101011000000110000111111100101100101100110001010100001010001011101111001111001001101111010010001101001110100001111101011011110111111101011011001001010110001010100001000110110001110011001100101101001011000100001111111111111100100101011011011000011101111110101000000001101110001011110100101000100010100000111111100010001101100100000111000000010101101100101111110100011100101110010011110001100111001001010000010001111110011100001001000111110001110100000100111011001100000111101100011110111001010010100010101111010010110111010011000000110111101010001111011011100111111111100001110001101010100100000010110100100010000010010011000011101011011110010010001100001111010111000010111110000101100010011001101100001010000010100011100000101010011011100100011000110111011011010100011000001101011011110000100001101010101101000100101001010101010011100000110010111000100001011101001101110110000110110100010101010111001000101101111001010111110111110000011111010001001000011100110000010010110110011110000111100101011110011001001110101001110001011000011111000111111000101000000110101000011111101001100111111001100011011011101001010000100110110000111111101011001110011010101100010111011101100111010101110111000010001111101101011011101100111001011111010111010011001010101000010011111000010010101110011101101101000100110111101001001000000011011000110101001011001011001000010010011010100111010101010110001111010100110101010000100000101000100111000001001011011101110101011010110001100010001001110011010001100001010110111110101001001101011010100101001001010001111001111100010111101100011001111000111100011100111001111001000100100010001001111010001101101000000110101100000011101000011000101000001110011001001100100111000100010000101101011011001001100000010110100100100000110110100000011000010100100111101110100001011100000010110001011111011110010111000000101000000111110010010111101100100110000111100011101101001010100111000111000111000101110110110001110010100100100001101101010011110001100100111101001001011101001001011110010010101100010010001000001110100011101111111101111000111101111001011010100001011010101001110110110011001110010101011001001100101100000100010110010101000001101101100001110100000111000001001011100111110000011011111001101101100101001010110110011001111111000100010100011101110011101001110011000001010011101110010000000001111010001101001110100011110011011011000100000111010101011000001101111000101111010010100110001000110110111010111000010101101010000011101100010001011110011010100110110110011010000010001000110101111110100111111001101011000101010110010011010100100000010111011000100111000010011001000001110010001110101011100111100010010001110000010000001100101100010000101100000110111101111001000101001110110101010111011001100111010010001000100100111111111101100111011100110010101100111101111111110111001011010110100101001001100010111111110100110000101001110011101100001000001100000110001111110111010110110100110000001100000101001000001100011111101010011111001000110001000011011000101101101011111001001000100100010111001110011000001111101000101100111110100110101101111011111111111100100011111111001111100111100001001101111001011010011011100100101100100011011110101010011101111111011011100011010100111111101001101011111011110111011010101001100111000010010001000001010011101100000001011110111111101001100101011010100101100101001011100100010100001100111111010001011110111000100101011011100010100100111011000111000111000110110110001101000011000100100100101011111010101001011101111100100000111111010100111101000101000101001011101111110011000111010001111011110001100100110111100110010101111001011100100010001100010001110010001111101111100010111000101101101111010010101010010101010000001010111100101111101001101110010111101100010000111101100111011011111011110111101111101111000101100100100101100000010010110000000010100110111011001000110111011111000111101100011010100100000001100000000001100000111100000010011111100100110000100101011111010100000000011010100100100110101010011010110001000011000111100011101010001010100101101011011011000111101111110101001011011111011110110011000110001101010001111110100011000001111000000001000110011000000111011001110110011100110100001000001110011011011000100110101011111010011010101011101000011000000010110101101011010100011110100001001010110110010001010100010001111010010100111010111100001101111000101000111000111101111111010100000011000111101010100000111010001101111111111111111101110010101010111000010111010000001110110111001001000010100111100111011101111000111110011001100000110010010001110110010000001111100101101110110101010111111011001001011000010010111011010100101000001011000101001100101110011111111111001110110001111010110000101010110111000110010111010110110001011111100000111111001011000110010000000011001001010100101110101101010110011001111111110100111110011110000001100000111001110001100010110100101001001000100011101111110101110010010111010100111110101010011001011000101110011010101110111011000010111100000111111110000100011101000100000011110111000111111000011111001000110011001110101010011101010101111110110101011001101000101001010011011000001010111110110100110001111110000010111010111001010010111110110101000001111111100000111110001110001101010001000100001101110011010000101110001110101010000101000111100111101011010111110001100101010100001111100000001110110000001110011100000100001110011010001000111111011101100001100000001101000101000011111110101100001101011011011000100000111101110011001100110001101001010000010001010101010110011111001011010100000011100100011001100101000001100010110011110001101110000011100101101111100100111001011100111011101101101111010111111010011001111001011000110100100001100110000101111100111101101001110000101110011000111111100100100001010101011010011110100001111110001100010011001001100000111111001011010101011011011011111100011011010010101100001011000011100110010011011000011100011101001001100011000100111001111000111011000001110101001011101100011010010110001010100000111100001001001011110100100000010000001110011010000111"

    p_value, result = DiehardOPERM5.run_test(test_data)
    print(f"OPERM5 Test: P-Value = {p_value}, Result = {result}")
    # try:
    #     p_value, result = DiehardOPERM5.run_test(test_data)
    #     print(f"OPERM5 Test: P-Value = {p_value}, Result = {result}")
    # except Exception as e:
    #     print(e)
